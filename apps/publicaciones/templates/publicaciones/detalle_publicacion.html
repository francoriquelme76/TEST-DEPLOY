{% extends 'base.html' %} 

{% block titulo %}{{ publicacion.titulo }}{% endblock titulo %}

{% block contenido %}

    <article>
        <h2>{{ publicacion.titulo }}</h2>
        
        <p>
            Categor铆a: <b>{{ publicacion.categoria }}</b> | 
            Autor: <b>{{ publicacion.autor }}</b> | 
            Publicado el: {{ publicacion.fecha_creacion|date:"d M Y" }}
        </p>

        <hr>

        <p>{{ publicacion.contenido }}</p>

        <hr>

        {# LGICA DE EDICIN: El bot贸n solo aparece si el usuario logueado es el autor #}
        {% if user.is_authenticated and user == publicacion.autor %}
            <p>
                {# Usamos la URL 'publicaciones:editar' que definimos en urls.py #}
                <a href="{% url 'publicaciones:editar' pk=publicacion.pk %}">
                    <button>Editar Publicaci贸n</button>
                </a>
            </p>
        {% endif %}

    </article>

    <hr>
    
    {#  COMENTARIOS  #}
    <h3 class="mt-4">Comentarios ({{ publicacion.comentarios.count }})</h3>
    
    {% for comentario in publicacion.comentarios.all %}
        <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
            <p>
                <strong>{{ comentario.autor.username }}</strong> dice:
                <small style="float: right;">{{ comentario.fecha_creacion|date:"d M Y H:i" }}</small>
            </p>
            <p>{{ comentario.contenido }}</p>
            
            {# LGICA DE EDICIN/ELIMINACIN DE COMENTARIO #}
            {% if user.is_authenticated and user == comentario.autor or user.is_superuser %}
                <small>
                    <a href="{% url 'comentarios:editar' comentario.pk %}">Editar</a> |
                    <a href="{% url 'comentarios:eliminar' comentario.pk %}">Eliminar</a>
                </small>
            {% endif %}
        </div>
    {% empty %}
        <p>S茅 el primero en comentar.</p>
    {% endfor %}

    <hr>

    {#  SECCIN COMENTAR: Formulario o Enlaces de Acceso  #}
    {% if user.is_authenticated %}
        <h4>Deja tu comentario</h4>
        {# El action del formulario debe apuntar a la URL de tu vista agregar_comentario #}
        <form method="post" action="{% url 'comentarios:agregar' publicacion_id=publicacion.pk %}">
            {% csrf_token %}
            
            {# Asumo que el formulario se llama 'form' o 'comentario_form' en la vista #}
            {{ form.as_p }} 
            
            <button type="submit">Enviar Comentario</button>
        </form>
    {% else %}
        {# ----------------------------------------------------------------------------------- #}
        {#  CORRECCIN UX APLICADA AQU  #}
        <div style="background-color: #ffe; border: 1px solid #ffd700; padding: 15px; margin-top: 20px; border-radius: 5px;">
            <p style="font-weight: bold; margin-bottom: 10px;">Para dejar un comentario, debes iniciar sesi贸n o registrarte.</p>
            <a href="{% url 'login' %}" style="margin-right: 15px; padding: 8px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px;">
                Iniciar Sesi贸n
            </a>
            <a href="{% url 'usuarios:registro' %}" style="padding: 8px 15px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px;">
                Registrarse
            </a>
        </div>
        {# ----------------------------------------------------------------------------------- #}
    {% endif %}

{% endblock contenido %}