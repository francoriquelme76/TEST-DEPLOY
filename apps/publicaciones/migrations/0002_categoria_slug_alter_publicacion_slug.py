# Generated by Django 6.0 on 2025-12-11 20:34

from django.db import migrations, models
from django.utils.text import slugify # 游뚿 Nuevo: Necesario para generar los slugs
import django.utils.timezone


# 游뚿 NUEVA FUNCI칍N CR칈TICA: Rellena los slugs de las categor칤as existentes 游뚿
def generar_slug_categorias(apps, schema_editor):
    # Obtenemos el modelo Categoria del estado hist칩rico de la migraci칩n
    Categoria = apps.get_model('publicaciones', 'Categoria')
    
    # Recorremos todas las categor칤as existentes
    for categoria in Categoria.objects.all():
        # Generamos el slug a partir del nombre, asegurando un valor 칰nico y v치lido
        categoria.slug = slugify(categoria.nombre)
        # Guardamos solo el slug, para evitar ejecutar la l칩gica de 'save()' del modelo completo
        categoria.save(update_fields=['slug'])
        
# -------------------------------------------------------------

class Migration(migrations.Migration):

    dependencies = [
        ('publicaciones', '0001_initial'),
    ]

    operations = [
        # PASO 1: A침adir el campo slug. Lo definimos como NULL=True TEMPORALMENTE 
        # para que SQLite pueda a침adir la columna sin fallar inmediatamente al copiar las filas.
        # Quitamos la restricci칩n unique=True por ahora, la aplicaremos despu칠s de rellenar.
        migrations.AddField(
            model_name='categoria',
            name='slug',
            field=models.SlugField(blank=True, max_length=100, null=True),
        ),
        
        # 游뚿 PASO 2: Ejecutar la funci칩n Python para rellenar los slugs de los datos existentes 游뚿
        migrations.RunPython(generar_slug_categorias, migrations.RunPython.noop),
        
        # PASO 3: AlterField para hacer el campo UNIQUE y NO NULO, ya que ahora est치 rellenado.
        migrations.AlterField(
            model_name='categoria',
            name='slug',
            field=models.SlugField(max_length=100, unique=True),
        ),

        # Mantenemos tu AlterField original para Publicacion
        migrations.AlterField(
            model_name='publicacion',
            name='slug',
            field=models.SlugField(blank=True, max_length=250, null=True, unique_for_date='fecha_creacion'),
        ),
    ]
